# Powershell script to execute when a new Windows VM is set up. 

Write-Output "[*] Initializing Provision Script..."

$RegPath = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"
$DefaultUsername = "your username"
$DefaultPassword = "your password"
Set-ItemProperty $RegPath "AutoAdminLogon" -Value "1" -type String 
Set-ItemProperty $RegPath "DefaultUsername" -Value "vagrant" -type String 
Set-ItemProperty $RegPath "DefaultPassword" -Value "vagrant" -type String

Write-Output "[*] Autologon Configured"

powercfg.exe /SETACVALUEINDEX SCHEME_CURRENT SUB_VIDEO VIDEOCONLOCK 3600
powercfg.exe /SETACTIVE SCHEME_CURRENT

powercfg.exe /SETDCVALUEINDEX SCHEME_CURRENT SUB_VIDEO VIDEOCONLOCK 3600
powercfg.exe /SETACTIVE SCHEME_CURRENT

Write-Output "[*] Screen Timeout extended"

Set-MpPreference -ExclusionPath C:\Users\vagrant\vagrant_data
Write-Output "[*] Vagrant folder added to Defender Exclusion"


cd C:\Users\vagrant\vagrant_data
Set-ExecutionPolicy Unrestricted -Force

# Setup Choco
$choco_command = Get-Command choco
if(-Not $choco_command) {
  iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
}
choco install -y psexec

# Attempt to disable the firewall and WinDefend
netsh advfirewall set allprofiles state off
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
Unblock-File disable-defender.ps1
.\disable-defender.ps1

Write-Output "[*] Win Defender disabled"

# Install Choco Apps
choco install -y 7zip
choco install -y wireshark
# choco install -y 'process explorer'
choco install -y die
choco install -y tcpview
choco install -y autoruns

# Copy over other tools
New-Item -Path 'C:\Tools\' -ItemType Directory
Copy-Item "C:\Users\vagrant\vagrant_data\Tools\capa.zip" -Destination "C:\Tools\capa.zip"
Copy-Item "C:\Users\vagrant\vagrant_data\Tools\fakenet.zip" -Destination "C:\Tools\fakenet.zip"
Copy-Item "C:\Users\vagrant\vagrant_data\Tools\pev.zip" -Destination "C:\Tools\pev.zip"
Get-ChildItem 'C:\Tools\' -Filter *.zip | Expand-Archive -DestinationPath 'C:\Tools' -Force

# # Winlogbeat
# cp "C:\Users\vagrant\vagrant_data\Winlogbeat\" "C:\Program Files\"
# cd "C:\Program Files\Winlogbeat\"
# .\install-service-winlogbeat.ps1
# .\winlogbeat.exe -c winlogbeat.yml -e
# .\winlogbeat.exe setup -e
# Start-Service winlogbeat

# # Setup Elastic Agent
# (New-Object Net.WebClient).DownloadFile("https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-7.16.2-windows-x86_64.zip", "C:\Users\vagrant\Downloads\elastic-agent.zip")

# # Sysmon
# cp "C:\Users\vagrant\vagrant_data\sysmon-config.xml" "C:\Windows\config.xml"
# C:\Users\vagrant\vagrant_data\Sysmon\Sysmon64.exe -accepteula -i C:\Windows\config.xml