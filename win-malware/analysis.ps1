$ANALYSIS_LOGS_DIR = "C:\Users\vagrant\vagrant_data\Analysis_Logs"

$payload = $args[0]

# Copy payload to C:\
Copy-Item "C:\Users\vagrant\vagrant_data\Payloads\$payload" -Destination "C:\$payload"

# Run Static PE Analysis
# cd C:\Tools\pev
# Write-Output "[*] Running PEV Tools..."
# .\pestr.exe "C:\$payload" > "$ANALYSIS_LOGS_DIR\pestr_log.tmp"
# mv $ANALYSIS_LOGS_DIR\pestr_log.tmp $ANALYSIS_LOGS_DIR\pestr_log.txt

# .\pehash.exe "C:\$payload" -f json > C:\Users\vagrant\vagrant_data\Analysis_Logs\pehash_log.tmp
# mv $ANALYSIS_LOGS_DIR\pehash_log.tmp $ANALYSIS_LOGS_DIR\pehash_log.json

# .\peldd.exe -f json C:\$payload > C:\Users\vagrant\vagrant_data\Analysis_Logs\peldd_log.tmp
# mv $ANALYSIS_LOGS_DIR\peldd_log.tmp $ANALYSIS_LOGS_DIR\peldd_log.json

# .\pescan.exe -f json C:\$payload > C:\Users\vagrant\vagrant_data\Analysis_Logs\pescan_log.tmp
# mv $ANALYSIS_LOGS_DIR\pescan_log.tmp $ANALYSIS_LOGS_DIR\pescan_log.json

# # Run Capa
# cd C:\Tools\capa
# Write-Output "[*] Running Capa..."
# .\capa.exe -j "C:\$payload" > C:\Users\vagrant\vagrant_data\Analysis_Logs\capa_log.tmp
# mv $ANALYSIS_LOGS_DIR\capa_log.tmp $ANALYSIS_LOGS_DIR\capa_log.json

# .\capa.exe "C:\$payload" > C:\Users\vagrant\vagrant_data\Analysis_Logs\capa_log.txt.tmp
# mv $ANALYSIS_LOGS_DIR\capa_log.txt.tmp $ANALYSIS_LOGS_DIR\capa_log.txt

# Begin Dynamic Analysis

# Run Fakenet
# cd C:\Tools\fakenet
# Write-Output "[*] Running Fakenet..."
# # .\fakenet.exe -l $ANALYSIS_LOGS_DIR\fakenet_log.txt.tmp
# Start-Process -FilePath "C:\Tools\fakenet\fakenet.exe" -ArgumentList "-l $ANALYSIS_LOGS_DIR\fakenet_log.txt.tmp" -WindowStyle Hidden
# Start-Sleep -Seconds 30

# Execute Payload
Write-Output "[*] Executing $payload"
Start-Process -FilePath "C:\$payload" -WindowStyle Hidden

Start-Sleep -Seconds 30
# Stop-Process -Name "fakenet"
# Write-Output "[*] Fakenet Stopped"
# mv $ANALYSIS_LOGS_DIR\fakenet_log.txt.tmp $ANALYSIS_LOGS_DIR\fakenet_log.txt
# mv C:\Tools\fakenet\*.pcap $ANALYSIS_LOGS_DIR\fakenet_log.pcap
# Write-Output "[*] Fakenet PCAP saved to Analysis_logs"

autorunsc.exe -m > $ANALYSIS_LOGS_DIR\autoruns_log.txt.tmp
mv $ANALYSIS_LOGS_DIR\autoruns_log.txt.tmp $ANALYSIS_LOGS_DIR\autoruns_log.txt
autorunsc.exe -c -m -nobanner > $ANALYSIS_LOGS_DIR\autoruns_log.tmp
mv $ANALYSIS_LOGS_DIR\autoruns_log.tmp $ANALYSIS_LOGS_DIR\autoruns_log.csv

Write-Output "[*] Analysis complete!"