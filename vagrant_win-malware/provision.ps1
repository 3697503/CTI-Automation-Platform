# Powershell script to execute when a new Windows VM is set up. 

Write-Output "[*] Initializing Provision Script..."
Set-ExecutionPolicy Unrestricted -Force

$RegPath = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"
$DefaultUsername = "vagrant"
$DefaultPassword = "vagrant"
Set-ItemProperty $RegPath "AutoAdminLogon" -Value "1" -type String 
Set-ItemProperty $RegPath "DefaultUsername" -Value "vagrant" -type String 
Set-ItemProperty $RegPath "DefaultPassword" -Value "vagrant" -type String

Write-Output "[*] Autologon Configured"

powercfg.exe /SETACVALUEINDEX SCHEME_CURRENT SUB_VIDEO VIDEOCONLOCK 3600
powercfg.exe /SETACTIVE SCHEME_CURRENT

powercfg.exe /SETDCVALUEINDEX SCHEME_CURRENT SUB_VIDEO VIDEOCONLOCK 3600
powercfg.exe /SETACTIVE SCHEME_CURRENT

Write-Output "[*] Screen Timeout extended"

Set-MpPreference -ExclusionPath C:\Users\vagrant\vagrant_data
Write-Output "[*] Vagrant folder added to Defender Exclusion"


cd C:\Users\vagrant\vagrant_data
Set-ExecutionPolicy Unrestricted -Force

# Setup Choco
$choco_command = Get-Command choco
if(-Not $choco_command) {
  iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
}
choco install -y psexec

# Attempt to disable the firewall and WinDefend
netsh advfirewall set allprofiles state off
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False
Unblock-File disable-defender.ps1
.\disable-defender.ps1

Write-Output "[*] Win Defender disabled"

# Install Choco Apps
choco install -y 7zip
choco install -y wireshark
choco install -y procexp
choco install -y die
choco install -y tcpview
choco install -y autoruns
choco install -y procmon

# Copy over other tools
New-Item -Path 'C:\Tools\' -ItemType Directory
Copy-Item "C:\Users\vagrant\vagrant_data\Tools\capa.zip" -Destination "C:\Tools\capa.zip"
Copy-Item "C:\Users\vagrant\vagrant_data\Tools\fakenet.zip" -Destination "C:\Tools\fakenet.zip"
Copy-Item "C:\Users\vagrant\vagrant_data\Tools\pev.zip" -Destination "C:\Tools\pev.zip"
Get-ChildItem 'C:\Tools\' -Filter *.zip | Expand-Archive -DestinationPath 'C:\Tools' -Force